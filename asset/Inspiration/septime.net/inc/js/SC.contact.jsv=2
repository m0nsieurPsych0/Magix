/**
 * SC / contact
 */
var SC = (function()
{
    var duration = 500;
    var interMail; // intervalles pour le clignotement quand erreur
    var interName;

    var unloadRub = function(rubs) {
        $('#bg-content').fadeOut(duration);
        // menu
        $('#site-nav > ul > li a').animate({
            width: '100%'
        }, duration * 0.5);
        $('#item-contact').fadeOut(duration, function() {
            SC.isUnloaded();
        });
        $('#item-contact-form-top, #item-contact-form-bottom, #form-return, #frm_email_error, #frm_name_error, #frm_captcha_error')
            .hide();
    };

    var loadRub = function(rubs) {
        var duration = 500;

        // Captcha
        $("#defaultReal").realperson();
        $("#defaultReal").attr('maxlength', '6');

        // Fond du contenu
        $('#bg-content')
                .show()
                .css({opacity: '0', left: '100%'})
                .animate({
            left: '35%',
            opacity: 1
        }, duration * 0.5);

        $('#site-nav > ul > li a.active').css('width', '100%');
        $('#site-nav > ul > li a:not(.active)').animate({
            width: '35%'
        }, duration * 0.5);

        $('#item-contact').fadeIn(duration);

        // Masque le bloc description + adresse
        $('#item-contact h3, #item-contact .vcard, #item-contact .small-vcard').hide();

        // Formulaire conservation des margin-top pour les anims
        $('#item-contact-form .realperson-text, #item-contact-form .realperson-regen')
            .each(function() {
                $(this).attr('data-mtop', $(this).css('margin-top'));
            });
        $('#item-contact-form p, #item-contact-form-bottom div')
            .css({ opacity: 0, 'margin-top': '-20px' })

        // Rajout du slash final
        var text = $('#item-contact h1').text();
        if (text.indexOf('/') == -1)
            text += ' /';

        $('#item-contact h1')
            .text('')
            .teletype({
                animDelay: 100,
                text: text
            }, showForm);

        // Event sur la soumission du formulaire
        $('#frm_post').on('click', onValidation);
        $('#item-contact-form').on('submit', onValidation);
        $('#item-contact-form :input').on('change keyup', check_form);
    };

    var showForm = function() {
        var addressSelector = $(window).height() > 768
            ? '#item-contact .vcard'
            : '#item-contact .small-vcard';

        // Suppression style inline pour permettre responsive
        $('#item-contact h3, ' + addressSelector)
            .fadeIn(duration, function() {
                $(this).removeAttr('style');
                $('#item-contact h3, #item-contact .vcard, #item-contact .small-vcard').removeAttr('style');
            })
            ;

		var len = $('#item-contact-form p, #item-contact-form-bottom div').length;
        $('#item-contact-form-top, #item-contact-form-bottom').show();
        $('#item-contact-form p, #item-contact-form-bottom div')
            .delay(1000)
            .each(function(i) {
                $(this)
                .delay(i * duration * 0.25)
                .animate(
                    {'margin-top': $(this).attr('mtop') || 0, opacity: 1},
                    {
                        duration: duration,
                        complete: function() {
                            $(this).removeAttr('style');
							if (i == len - 1) {
								SC.isLoaded();
							}
                        }
                    }
                );
        });
    };

    var onValidation = function(e) {
        e.preventDefault();
        check_form(true);
    };


    var highlightMail = function() {
    	interMail = setInterval(function () {
    		$('#frm_email').toggleClass('error');
    	}, 300);
    }

    var stopHighlightMail = function() {
    	clearInterval(interMail);
    	$('#frm_email').removeClass('error');
    }

    var highlightName = function() {
    	interName = setInterval(function () {
    		$('#frm_name').toggleClass('error');
    	}, 300);
    }

    var stopHighlightName = function() {
    	clearInterval(interName);
    	$('#frm_name').removeClass('error');
    }

    var check_form = function(post)
    {
        post = post === true ? true : false;

        // Check champs formualaire
        var name_error = false,
            mail_error = false,
            name_error_msg = '',
            mail_error_msg = '';

        // Check if name is empty
        //$('#frm_name').removeClass('error');
        stopHighlightName();
        if (!$('#frm_name').val().length)
        {
            //$('#frm_name').addClass('error');
        	highlightName();
            name_error = true;
            if (post)
            {
                name_error_msg = contact.locales.nameEmpty;
                $('#frm_name_error')
                    .html(name_error_msg)
                    .slideDown("slow");
            }
        }
        else if (post)
        {
             $("#frm_name_error").slideUp("slow");
        }
        else
        {
             $("#frm_name_error").hide();
        }

        // Check if mail is not empty and well formatted
        if (!$('#frm_email').val().length)
        {
            mail_error = true;
            mail_error_msg = contact.locales.emailEmpty;
        }
        else if (!isValidEmail($('#frm_email').val()))
        {
            mail_error = true;
            mail_error_msg = contact.locales.emailInvalid;
        }
        else
        {
            mail_error_msg = '';
        }
        post && $('#frm_email_error').html(mail_error_msg);

        // On email error
        //$('#frm_email').removeClass('error');
        stopHighlightMail();
        if (mail_error)
        {
            //$('#frm_email').addClass('error');
        	highlightMail();
            post && $("#frm_email_error").slideDown("slow");
        }
        else if (post)
        {
            $("#frm_email_error").slideUp("slow");
        }
        else
        {
            $("#frm_email_error").hide();
        }

        // If no error, post form
        if (!name_error && !mail_error)
        {
            // S'il faut poster, on poste, sinon on enlève le vérou sur le bouton vérouiller
            post && post_form() || $('#frm_post').removeAttr('disabled');
        }
        else
        {
            $('#frm_post').attr('disabled', 'disabled');
        }

        return false;
    };

    // Form: post data via xhr
    var post_form = function()
    {
        $('#frm_post').attr('disabled', 'disabled').text(contact.locales.loading);
        // Envoi des données en xhr
        $.ajax(
        {   type: 'POST',
            data: $('#item-contact-form').serialize(),
            url:  $('#item-contact-form').attr('action'),
            timeout: 30000,
            cache: false,
            complete: function(jqXHR, textStatus) {  },
            success:  function(data) { post_form_succes(data); },
            error:    function(jqXHR, textStatus, errorThrown){ post_form_error(jqXHR, textStatus, errorThrown); }
        });

        return false;
    };

    // Form: on (xhr) post success
    var post_form_succes = function(data){
        // Retour post formulaire
        if (data == "captchaError")
        {
            $('#frm_captcha_error')
                .html(contact.locales.codeEmpty)
                .slideDown("slow");

            $('#frm_post')
                .text(contact.locales.send)
                .css('background-color','#42484E');
        }
        if (data == "fail") {
            $('#form-return').html(contact.locales.errorTryAgain);
            post_form_return();
        }
        if (data == "ok") {
            $('#form-return').html(contact.locales.success);

            // google analytics
        	if (typeof _gaq != 'undefined') {
        		_gaq.push(['_trackEvent', 'submit', 'formContact', '', 0, true]);
        	}

            post_form_return();
        }
        return false;
    };
    // Form: on (xhr) post error
    var post_form_error = function(data)
    {
        // Retour post formulaire
        $('#frm_post')
            .text(contact.locales.send)
            .css('background-color','#42484E');
        return false;
    };

    // Form: displaying error message or sending confirmation message
    var post_form_return = function(){
        $('#item-contact-form-top, #item-contact-form-bottom')
            .delay(1000)
            .each(function(i) {
                var opts = { duration: duration };
                if (i)
                {
                    opts['complete'] = function(){
                        // Reset du formulaire
                        $('#item-contact-form :input').val('');
                        $('#item-contact-form .realperson-regen').trigger('click');
                        $('#form-return').slideDown();
                    };
                }
                $(this)
                    .delay(i * duration * 0.25)
                    .fadeOut(opts);
        });
    };

    // Check mail syntax
    var isValidEmail = function(email)
    {
        return /^([a-zA-Z0-9_-])+([.]?[a-zA-Z0-9_-]{1,})*@([a-zA-Z0-9-_]{2,}[.])+[a-zA-Z]{2,3}$/.test(email);
    };

    // public
    this.loadRub_contact = loadRub;

    this.unloadRub_contact = unloadRub;

    return this;
}).apply(SC);
